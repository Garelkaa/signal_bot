from aiogram import F, types

from signature import BotSettings

from keyboards.client_kb import ReplyKb as kb

class Client:
    def __init__(self, bot: BotSettings):
        self.bot = bot.bot
        self.dp = bot.dp
        self.db = bot.db

    async def register_handlers(self):
        self.dp.message(F.text.startswith("/start"))(self.start_handler)
        self.dp.callback_query(F.data == "acknowledge_instructions")(self.acknowledge_instructions_handler)

    async def start_handler(self, m: types.Message):
        user_exists = await self.db.user_exists(m.from_user.id)
        
        if user_exists:
            await m.answer(
                "üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ SIGNAL BOT MINES!\n\n"
                "üéÆ Mines ‚Äî —ç—Ç–æ –∞–∑–∞—Ä—Ç–Ω–∞—è –∏–≥—Ä–∞ –≤ 1win, –æ—Å–Ω–æ–≤–∞–Ω–Ω–∞—è –Ω–∞ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–æ–º ¬´–°–∞–ø—ë—Ä–µ¬ª.\n"
                "‚ú® –¶–µ–ª—å –∏–≥—Ä—ã ‚Äî –æ—Ç–∫—Ä—ã–≤–∞—Ç—å –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ —è—á–µ–π–∫–∏, –∏–∑–±–µ–≥–∞—è –ª–æ–≤—É—à–µ–∫.\n\n"
                "ü§ñ –ù–∞—à –±–æ—Ç, —Ä–∞–±–æ—Ç–∞—é—â–∏–π –Ω–∞ –Ω–µ–π—Ä–æ—Å–µ—Ç–∏, —Å–ø–æ—Å–æ–±–µ–Ω –ø—Ä–µ–¥—Å–∫–∞–∑—ã–≤–∞—Ç—å —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ –∑–≤—ë–∑–¥ —Å —Ç–æ—á–Ω–æ—Å—Ç—å—é –¥–æ 92%.\n\n"
                "üìä –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–µ–Ω—é –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –∏ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–∏–≥–Ω–∞–ª–æ–≤!"
            )
            return

        command_parts = m.text.split(maxsplit=1)
        if len(command_parts) == 1:
            await m.answer("‚ùóÔ∏è –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤–æ–∑–º–æ–∂–Ω–∞ —Ç–æ–ª—å–∫–æ –ø–æ —Å—Å—ã–ª–∫–µ, –≤—ã–¥–∞–Ω–Ω–æ–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.")
        else:
            code = await self.db.get_ref_code(command_parts[1])
            if code:
                instructions = (
                    "üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ SIGNAL BOT MINES!\n\n"
                    "üìå –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:\n"
                    "–ë–æ—Ç –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —Å–∏–≥–Ω–∞–ª—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–∞—à–µ–≥–æ ID, –¥–µ–ø–æ–∑–∏—Ç–∞ –∏ —Å—É–º–º—ã —Å—Ç–∞–≤–∫–∏. "
                    "–ê–ª–≥–æ—Ä–∏—Ç–º –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ—Å—Ç—Ä–æ–µ–Ω –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–µ–π—Ä–æ—Å–µ—Ç–∏.\n\n"
                    "üìñ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:\n"
                    "1Ô∏è‚É£ –ï—Å–ª–∏ –≤—ã —É–∂–µ —Å–¥–µ–ª–∞–ª–∏ –ø–µ—Ä–≤—É—é —Å—Ç–∞–≤–∫—É –±–µ–∑ –±–æ—Ç–∞, –ø–æ–ø–æ–ª–Ω–∏—Ç–µ –±–∞–ª–∞–Ω—Å –Ω–∞ —Ç—É –∂–µ —Å—É–º–º—É "
                    "–∏ —Å–¥–µ–ª–∞–π—Ç–µ —Å—Ç–∞–≤–∫—É –ø–æ –ø—Ä–æ–≥–Ω–æ–∑—É –±–æ—Ç–∞.\n"
                    "2Ô∏è‚É£ –ï—Å–ª–∏ –≤—ã –ø—Ä–æ–∏–≥—Ä–∞–ª–∏ —Ö–æ—Ç—è –±—ã –¥–≤–µ –ø–µ—Ä–≤—ã–µ —Å—Ç–∞–≤–∫–∏, –ø–æ–ø–æ–ª–Ω–∏—Ç–µ –±–∞–ª–∞–Ω—Å –Ω–∞ —Ç—É –∂–µ —Å—É–º–º—É –∏ –æ–±–Ω–æ–≤–∏—Ç–µ –±–æ—Ç–∞.\n\n"
                    "–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —ç—Ç–∏—Ö —à–∞–≥–æ–≤ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç–µ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —ç—Ç–∞–ø—É!"
                )
                await m.answer(instructions, reply_markup=await kb.accept())
            else:
                await m.answer("‚õîÔ∏è –ù–µ–≤–µ—Ä–Ω–∞—è –∏–ª–∏ –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞ –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.")

    async def acknowledge_instructions_handler(self, cq: types.CallbackQuery):
        user_exists = await self.db.user_exists(cq.from_user.id)
        
        if user_exists:
            await cq.message.delete()
            await cq.message.answer(
                "üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ SIGNAL BOT MINES!\n\n"
                "üéÆ Mines ‚Äî —ç—Ç–æ –∞–∑–∞—Ä—Ç–Ω–∞—è –∏–≥—Ä–∞ –≤ 1win, –æ—Å–Ω–æ–≤–∞–Ω–Ω–∞—è –Ω–∞ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–æ–º ¬´–°–∞–ø—ë—Ä–µ¬ª.\n"
                "‚ú® –¶–µ–ª—å –∏–≥—Ä—ã ‚Äî –æ—Ç–∫—Ä—ã–≤–∞—Ç—å –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ —è—á–µ–π–∫–∏, –∏–∑–±–µ–≥–∞—è –ª–æ–≤—É—à–µ–∫.\n\n"
                "ü§ñ –ù–∞—à –±–æ—Ç, —Ä–∞–±–æ—Ç–∞—é—â–∏–π –Ω–∞ –Ω–µ–π—Ä–æ—Å–µ—Ç–∏, —Å–ø–æ—Å–æ–±–µ–Ω –ø—Ä–µ–¥—Å–∫–∞–∑—ã–≤–∞—Ç—å —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ –∑–≤—ë–∑–¥ —Å —Ç–æ—á–Ω–æ—Å—Ç—å—é –¥–æ 92%.\n\n"
                "üìä –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–µ–Ω—é –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –∏ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–∏–≥–Ω–∞–ª–æ–≤!"
            )
            await cq.answer()
            return
        
        await self.db.add_user(
            uid=cq.from_user.id,
            uname=cq.from_user.username if cq.from_user.username else cq.from_user.first_name
        )
        await cq.message.delete()
        await cq.message.answer(
            "üéâ –í—ã —É—Å–ø–µ—à–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –≤ SIGNAL BOT MINES!\n\n"
            "üéÆ Mines ‚Äî —ç—Ç–æ –∞–∑–∞—Ä—Ç–Ω–∞—è –∏–≥—Ä–∞ –≤ 1win, –æ—Å–Ω–æ–≤–∞–Ω–Ω–∞—è –Ω–∞ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–æ–º ¬´–°–∞–ø—ë—Ä–µ¬ª.\n"
            "‚ú® –¶–µ–ª—å –∏–≥—Ä—ã ‚Äî –æ—Ç–∫—Ä—ã–≤–∞—Ç—å –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ —è—á–µ–π–∫–∏, –∏–∑–±–µ–≥–∞—è –ª–æ–≤—É—à–µ–∫.\n\n"
            "ü§ñ –ù–∞—à –±–æ—Ç, —Ä–∞–±–æ—Ç–∞—é—â–∏–π –Ω–∞ –Ω–µ–π—Ä–æ—Å–µ—Ç–∏, —Å–ø–æ—Å–æ–±–µ–Ω –ø—Ä–µ–¥—Å–∫–∞–∑—ã–≤–∞—Ç—å —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ –∑–≤—ë–∑–¥ —Å —Ç–æ—á–Ω–æ—Å—Ç—å—é –¥–æ 92%.\n\n"
            "üìä –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–µ–Ω—é –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –∏ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–∏–≥–Ω–∞–ª–æ–≤!"
        )
        await cq.answer()
